<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de Ticket</title>
  <style>
    /* ... tu CSS existente ... */
  </style>
</head>
<body>
  <form id="miFormulario">
    <h2>Crear nuevo ticket</h2>
    <div>
      <label for="fecha">Fecha</label>
      <input type="date" id="fecha" name="fecha" required>
    </div>
    <div>
      <label for="consorcio">Consorcio</label>
      <input type="text" id="consorcio" name="consorcio" required>
    </div>
    <div>
      <label for="piso">Piso</label>
      <select id="piso" name="piso" required>
        <option value="">Cargando…</option>
      </select>
    </div>
    <!-- resto de campos igual -->
    <div>
      <label for="foto">Foto</label>
      <input type="file" id="foto" name="foto" accept="image/*" capture="environment">
    </div>
    <button type="button" id="btnEnviar">Enviar Ticket</button>
  </form>

  <div id="successMsg" style="display:none">
    <p>¡Ticket enviado con éxito!</p>
    <span id="ticketNumber"></span>
    <button onclick="location.reload()">Enviar otro ticket</button>
  </div>

  <script>
    // — URL de tu Web App (la que obtuviste al desplegar el Code.gs) —
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzgF5opU-YfG9Y-gqv-5A8_CtlZG1TJBwCwCAEeLqhrKG2XBukDc4i4J7RifaOuN6mb/exec';

    document.addEventListener('DOMContentLoaded', () => {
      // 1) Fecha de hoy
      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth()+1).padStart(2,'0');
      const dd = String(hoy.getDate()).padStart(2,'0');
      document.getElementById('fecha').value = `${yyyy}-${mm}-${dd}`;

      // 2) Leer consorcio desde query param si viene: ?consorcio=XYZ
      const params = new URLSearchParams(window.location.search);
      const cons = params.get('consorcio') || '';
      document.getElementById('consorcio').value = cons;

      // 3) Poblar pisos si hay consorcio
      if (cons) fetchPisos(cons);

      // 4) Cuando cambie el consorcio, recargar pisos
      document.getElementById('consorcio').addEventListener('change', e => {
        fetchPisos(e.target.value);
      });
    });

    // Función para pedir pisos
    async function fetchPisos(consorcio) {
      const sel = document.getElementById('piso');
      sel.innerHTML = '<option value="">Cargando…</option>';
      try {
        const resp = await fetch(`${WEB_APP_URL}?action=getPisos&consorcio=${encodeURIComponent(consorcio)}`);
        const json = await resp.json();
        sel.innerHTML = '';
        if (json.pisos && json.pisos.length) {
          json.pisos.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.textContent = p;
            sel.appendChild(opt);
          });
        } else {
          sel.innerHTML = '<option value="">No hay pisos</option>';
        }
      } catch (err) {
        sel.innerHTML = '<option value="">Error cargando</option>';
        console.error(err);
      }
    }

    // Envío del formulario
    document.getElementById('btnEnviar').addEventListener('click', async function() {
      const btn = this;
      const orig = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Enviando…';

      const form = document.getElementById('miFormulario');
      const data = {
        fecha: form.fecha.value,
        consorcio: form.consorcio.value,
        piso: form.piso.value,
        nombre: form.nombre.value,
        rubro: form.rubro.value,
        descripcion: form.descripcion.value
      };

      const fileInput = document.getElementById('foto');
      if (fileInput.files.length) {
        const reader = new FileReader();
        reader.onload = async e => {
          const base = e.target.result.split(',')[1];
          data.fotoData = base;
          data.fotoType = fileInput.files[0].type;
          data.fotoName = fileInput.files[0].name;
          await enviarData();
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        await enviarData();
      }

      async function enviarData() {
        try {
          const resp = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(data)
          });
          const resJson = await resp.json();
          if (resJson.success) {
            document.getElementById('ticketNumber').textContent = "N° de ticket: " + resJson.ticketNumber;
            form.style.display = 'none';
            document.getElementById('successMsg').style.display = 'block';
          } else {
            throw new Error(resJson.error);
          }
        } catch (err) {
          alert('Error: ' + err.message);
          btn.disabled = false;
          btn.textContent = orig;
        }
      }
    });
  </script>
</body>
</html>

